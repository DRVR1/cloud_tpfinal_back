# Nombre del workflow (aparecer√° en la pesta√±a "Actions" de GitHub)
name: CI/CD Completo: Build, Push y Despliegue SSH

# Define cu√°ndo se debe ejecutar este workflow
on:
  push:
    branches:
      - main  # Se ejecuta solo en cada push a la rama 'main'
  # Permite la ejecuci√≥n manual desde la pesta√±a Actions
  workflow_dispatch:

# Define los trabajos (jobs) que se van a ejecutar
jobs:
  # =========================================================
  # TRABAJO 1: BUILD Y PUSH A DOCKER HUB
  # =========================================================
  build-and-push:
    name: Build y Push de Im√°genes Docker
    runs-on: ubuntu-latest

    steps:
      - name: üìù Check out repository
        uses: actions/checkout@v4

      - name: üîë Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üõ†Ô∏è Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # --- CONSTRUYE Y SUBE IANVID/CLOUDBACK ---
      - name: üèóÔ∏è Build and push ianvid/cloudback:latest
        uses: docker/build-push-action@v5
        with:
          # ATENCI√ìN: Ajusta 'context' y 'file' si tu Dockerfile no est√° en el directorio ra√≠z o './cloudback'
          context: ./cloudback
          file: ./cloudback/Dockerfile
          push: true
          tags: ianvid/cloudback:latest

      # --- CONSTRUYE Y SUBE IANVID/CLOUDFRONT ---
      - name: üèóÔ∏è Build and push ianvid/cloudfront:latest
        uses: docker/build-push-action@v5
        with:
          # ATENCI√ìN: Ajusta 'context' y 'file' si tu Dockerfile no est√° en el directorio ra√≠z o './cloudfront'
          context: ./cloudfront
          file: ./cloudfront/Dockerfile
          push: true
          tags: ianvid/cloudfront:latest

  # =========================================================
  # TRABAJO 2: DESPLIEGUE SSH (S√ìLO SI EL PRIMER TRABAJO FUE EXITOSO)
  # =========================================================
  deploy:
    name: Despliegue a Azure VM
    runs-on: ubuntu-latest
    
    # ESTO ES CRUCIAL: Este job SOLO se ejecutar√° si 'build-and-push' termina correctamente.
    needs: [build-and-push] 

    steps:
    - name: üöÄ SSH y Ejecuci√≥n de Comandos de Despliegue
      uses: appleboy/ssh-action@v1.0.3
      with:
        # Configuraci√≥n de Conexi√≥n SSH (Secretos de GitHub)
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        
        # Comandos a ejecutar en la sesi√≥n SSH remota
        script: |
          echo "Iniciando despliegue remoto..."
          
          # 1. Pull de las √∫ltimas im√°genes (ya subidas por el trabajo anterior)
          echo "Haciendo pull de las √∫ltimas im√°genes de Docker Hub..."
          sudo docker pull ianvid/cloudfront:latest
          sudo docker pull ianvid/cloudback:latest
          
          # 2. Levantar los servicios con docker compose
          # ATENCI√ìN: Aseg√∫rate de que este comando se ejecuta desde el directorio donde est√° tu docker-compose.yml
          cd
          echo "Levantando los servicios con docker compose..."
          sudo docker compose up -d
          
          echo "Despliegue finalizado exitosamente."